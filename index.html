<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traductor LSA Argentina Funcional</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    <style>
        /* Estilos móviles optimizados */
        body { margin: 0; padding: 15px; font-family: Arial, sans-serif; }
        #videoPreview { width: 100%; height: 60vh; transform: scaleX(-1); }
        #outputText { font-size: 1.2em; margin-top: 15px; padding: 10px; border: 2px solid #2ecc71; border-radius: 8px; }
    </style>
</head>
<body>
    <video id="videoPreview" autoplay playsinline></video>
    <div id="outputText"></div>

<script>
// 1. Definir el objeto Vision correctamente
const vision = window;
let gestureRecognizer;
let lastDetection = 0;
const sentence = [];

// 2. Mapeo de gestos LSA Argentina
const GESTURE_MAP = {
    'Thumb_Up': 'Hola',
    'Open_Palm': ' ',
    'Closed_Fist': 'A',
    'Victory': 'B',
    'Pointing_Up': 'C',
    'ILoveYou': 'D',
    'Thumb_Down': 'E',
    'Raised_Hand': 'F',
    'Finger_Heart': 'Gracias',
    'Hand_Wave': 'Adiós'
};

// 3. Inicialización corregida
async function initialize() {
    try {
        const fileset = await vision.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        
        gestureRecognizer = await vision.GestureRecognizer.createFromOptions(
            fileset,
            {
                baseOptions: {
                    modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task',
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 2,
                minHandDetectionConfidence: 0.7
            }
        );
        
        startCamera();
    } catch (error) {
        console.error('Error de inicialización:', error);
        document.getElementById('outputText').textContent = 'Error al cargar el modelo';
    }
}

// 4. Configuración de cámara móvil
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "user",
                width: { ideal: 360 },
                height: { ideal: 640 }
            }
        });
        
        const video = document.getElementById('videoPreview');
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            video.play();
            detectGestures();
        };
    } catch (error) {
        console.error('Error de cámara:', error);
    }
}

// 5. Detección en tiempo real optimizada
async function detectGestures() {
    const video = document.getElementById('videoPreview');
    
    while (true) {
        if (!gestureRecognizer) await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
            const results = gestureRecognizer.recognizeForVideo(video, Date.now());
            processResults(results);
        } catch (error) {
            console.error('Error de detección:', error);
        }
        
        await new Promise(resolve => requestAnimationFrame(resolve));
    }
}

// 6. Procesamiento de resultados
function processResults(results) {
    const currentTime = Date.now();
    
    if (results.gestures && results.gestures.length > 0 && (currentTime - lastDetection > 1000)) {
        const mainGesture = results.gestures[0][0];
        
        if (mainGesture.score >= 0.7) {
            const translation = GESTURE_MAP[mainGesture.categoryName] || '';
            updateOutput(translation);
            lastDetection = currentTime;
        }
    }
}

// 7. Actualización de la salida
function updateOutput(text) {
    sentence.push(text);
    
    if (sentence.length > 15) {
        sentence.splice(0, 5);
    }
    
    document.getElementById('outputText').textContent = sentence.join(' ')
        .replace(/\s+/g, ' ')
        .trim();
}

// Iniciar
initialize();
</script>
</body>
</html>
