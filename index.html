<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Traductor LSA Funcional</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/vision_bundle.js"></script>
</head>
<body>
    <video id="videoPreview" width="640" height="480" autoplay></video>
    <div id="outputText" style="font-size: 1.5em; margin-top: 20px;"></div>

<script>
const videoElement = document.getElementById('videoPreview');
const outputDiv = document.getElementById('outputText');
let gestureRecognizer;
let lastDetectionTime = 0;
let sentence = [];
let previousGestures = [];

// Configuración del modelo
const initializeGestureRecognizer = async () => {
    const vision = await Vision.FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm"
    );

    gestureRecognizer = await Vision.GestureRecognizer.createFromOptions(
        vision,
        {
            baseOptions: {
                modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                delegate: "GPU"
            },
            runningMode: "VIDEO",
            numHands: 2,
            minHandDetectionConfidence: 0.8,
            minTrackingConfidence: 0.5
        }
    );
};

// Mapeo mejorado de gestos
const gestureMapping = {
    'Thumb_Up': 'Hola',
    'Open_Palm': ' ',
    'Closed_Fist': 'A',
    'Victory': 'Bien',
    'Pointing_Up': 'Yo',
    'ILoveYou': 'Amor',
    'Thumb_Down': 'No',
    'Call_me': 'Llamar',
    'Rock': 'Genial',
    'Finger_Heart': 'Gracias'
};

// Procesamiento optimizado
const processFrame = async () => {
    if (!gestureRecognizer || videoElement.readyState < 2) {
        requestAnimationFrame(processFrame);
        return;
    }

    try {
        const results = gestureRecognizer.recognizeForVideo(videoElement, Date.now());
        
        if (results.gestures.length > 0) {
            handleGestures(results);
        }
        
        requestAnimationFrame(processFrame);
    } catch (error) {
        console.error('Error en procesamiento:', error);
    }
};

// Manejo de gestos detectados
const handleGestures = (results) => {
    const currentTime = Date.now();
    const timeSinceLast = currentTime - lastDetectionTime;
    
    const gestures = results.gestures[0]
        .filter(g => g.score > 0.8)
        .map(g => g.categoryName);

    if (gestures.length === 0 || timeSinceLast < 500) return;

    // Detección de secuencias
    previousGestures.push(...gestures);
    if (previousGestures.length > 5) previousGestures.shift();

    // Mapeo a texto
    const detectedText = mapGesturesToText(previousGestures);
    
    if (detectedText) {
        updateSentence(detectedText);
        lastDetectionTime = currentTime;
        previousGestures = [];
    }
};

// Mapeo inteligente de gestos
const mapGesturesToText = (gestures) => {
    const uniqueGestures = [...new Set(gestures)];
    
    // Priorizar gestos específicos
    if (uniqueGestures.includes('ILoveYou')) return 'Te quiero';
    if (uniqueGestures.includes('Finger_Heart')) return 'Gracias';
    
    // Combinación de gestos
    if (uniqueGestures.includes('Thumb_Up') && uniqueGestures.includes('Open_Palm')) {
        return 'Hola a todos';
    }
    
    // Mapeo directo
    return gestureMapping[uniqueGestures[0]] || '';
};

// Construcción de frases
const updateSentence = (text) => {
    if (text === 'Backspace') {
        sentence = sentence.slice(0, -1);
    } else {
        sentence.push(text);
    }
    
    outputDiv.textContent = sentence.join('')
        .replace(/\s+/g, ' ')
        .trim();
};

// Inicialización de cámara mejorada
const startCamera = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
                frameRate: { ideal: 30 }
            }
        });
        
        videoElement.srcObject = stream;
        
        await new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
                videoElement.width = videoElement.videoWidth;
                videoElement.height = videoElement.videoHeight;
                resolve();
            };
        });
        
        await initializeGestureRecognizer();
        processFrame();
    } catch (error) {
        outputDiv.textContent = 'Error: Permite el acceso a la cámara y recarga la página.';
        console.error('Error de cámara:', error);
    }
};

// Iniciar aplicación
startCamera();

// Manejo de errores global
window.addEventListener('error', (e) => {
    outputDiv.textContent = `Error: ${e.message}`;
    console.error(e);
});
</script>
</body>
</html>
