<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Traductor LSA Funcional</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    <style>
        body { margin: 20px; font-family: Arial, sans-serif; }
        #videoPreview { transform: scaleX(-1); }
        #outputText { font-size: 1.5em; margin-top: 10px; padding: 10px; border: 2px solid #2ecc71; }
        #status { color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <video id="videoPreview" width="640" height="480" autoplay playsinline></video>
    <div id="outputText"></div>
    <div id="status">Inicializando...</div>

<script>
const videoElement = document.getElementById('videoPreview');
const outputDiv = document.getElementById('outputText');
const statusDiv = document.getElementById('status');
let gestureRecognizer = null;
let lastGestureTime = 0;
let sentence = [];
let cameraStream = null;

// 1. Configuración mejorada del modelo
async function setupGestureRecognizer() {
    try {
        statusDiv.textContent = "Cargando modelo de IA...";
        const vision = await Vision.FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
        );
        
        gestureRecognizer = await Vision.GestureRecognizer.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
                delegate: "GPU"
            },
            runningMode: "VIDEO",
            numHands: 2,
            minHandDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });
        statusDiv.textContent = "Modelo listo!";
    } catch (error) {
        statusDiv.textContent = "Error cargando el modelo";
        console.error("Error de inicialización:", error);
    }
}

// 2. Mapeo completo de gestos LSA Argentina
const gestureMap = {
    'Thumb_Up': 'Hola',
    'Open_Palm': ' ',
    'Closed_Fist': 'A',
    'Victory': 'B',
    'Pointing_Up': 'C',
    'ILoveYou': 'D',
    'Thumb_Down': 'E',
    'Call_me': 'F',
    'Raised_Hand': 'G',
    'Finger_Heart': 'Gracias',
    'Rock': 'Por favor',
    'Hand_Wave': 'Adiós'
};

// 3. Procesamiento de video optimizado
async function processFrame() {
    if (!gestureRecognizer || !videoElement.srcObject) {
        requestAnimationFrame(processFrame);
        return;
    }

    try {
        const results = gestureRecognizer.recognizeForVideo(videoElement, Date.now());
        
        if (results.gestures.length > 0) {
            const currentTime = Date.now();
            const mainGesture = results.gestures[0][0];
            
            if (mainGesture.score > 0.7 && (currentTime - lastGestureTime) > 1000) {
                const gestureText = gestureMap[mainGesture.categoryName] || '';
                
                if (gestureText) {
                    sentence.push(gestureText);
                    outputDiv.textContent = formatSentence(sentence);
                    lastGestureTime = currentTime;
                    statusDiv.textContent = `Detectado: ${mainGesture.categoryName} (${mainGesture.score.toFixed(2)})`;
                }
            }
        }
    } catch (error) {
        console.error("Error procesando frame:", error);
    }
    
    requestAnimationFrame(processFrame);
}

// 4. Formateo inteligente de texto
function formatSentence(words) {
    return words.join('')
        .replace(/\s+/g, ' ')
        .replace(/(\s)([.,!?])/g, '$2')
        .trim();
}

// 5. Inicialización robusta de cámara
async function startCamera() {
    try {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user",
                frameRate: { ideal: 24 }
            }
        });
        
        videoElement.srcObject = cameraStream;
        await videoElement.play();
        
        await setupGestureRecognizer();
        processFrame();
    } catch (error) {
        statusDiv.textContent = "Error: Permite acceso a la cámara y recarga la página.";
        console.error("Error de cámara:", error);
    }
}

// 6. Control de limpieza
window.addEventListener('beforeunload', () => {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
});

// Iniciar aplicación
startCamera();
</script>
</body>
</html>
