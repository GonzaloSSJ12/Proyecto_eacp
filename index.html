<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traductor LSA Argentina</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f2f5;
        }
        #videoContainer {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            position: relative;
        }
        #videoElement {
            width: 100%;
            height: auto;
            transform: scaleX(-1);
            border-radius: 10px;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-size: 1.2em;
            min-height: 60px;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="videoElement" autoplay playsinline></video>
    </div>
    <div id="output"></div>

<script type="module">
import { GestureRecognizer, FilesetResolver } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/vision_bundle.js';

class SignLanguageTranslator {
    constructor() {
        this.recognizer = null;
        this.video = document.getElementById('videoElement');
        this.output = document.getElementById('output');
        this.lastGestureTime = 0;
        this.sentence = [];
        this.init();
    }

    async init() {
        await this.setupCamera();
        await this.loadModel();
        this.detectGestures();
    }

    async setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'user',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            });
            this.video.srcObject = stream;
            await new Promise(resolve => this.video.onloadedmetadata = resolve);
        } catch (error) {
            this.output.textContent = 'Error: Permite acceso a la cámara';
            console.error('Camera error:', error);
        }
    }

    async loadModel() {
        try {
            const vision = await FilesetResolver.forVisionTasks(
                'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.7/wasm'
            );
            
            this.recognizer = await GestureRecognizer.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/latest/gesture_recognizer.task',
                    delegate: 'GPU'
                },
                runningMode: 'VIDEO',
                numHands: 2,
                minHandDetectionConfidence: 0.8
            });
        } catch (error) {
            this.output.textContent = 'Error cargando el modelo';
            console.error('Model load error:', error);
        }
    }

    async detectGestures() {
        if (!this.recognizer) return;

        const processFrame = async () => {
            try {
                const results = this.recognizer.recognizeForVideo(this.video, Date.now());
                this.processResults(results);
            } catch (error) {
                console.error('Detection error:', error);
            }
            requestAnimationFrame(processFrame);
        };
        
        processFrame();
    }

    processResults(results) {
        if (!results.gestures || results.gestures.length === 0) return;

        const currentTime = Date.now();
        if (currentTime - this.lastGestureTime < 1000) return;

        const gestures = results.gestures[0]
            .filter(g => g.score >= 0.8)
            .map(g => this.translateGesture(g.categoryName));

        if (gestures.length > 0) {
            this.updateSentence(gestures[0]);
            this.lastGestureTime = currentTime;
        }
    }

    translateGesture(gesture) {
        const gesturesMap = {
            'Thumb_Up': 'Hola',
            'Open_Palm': ' ',
            'Closed_Fist': 'A',
            'Victory': 'B',
            'Pointing_Up': 'C',
            'ILoveYou': 'D',
            'Thumb_Down': 'E',
            'Raised_Hand': 'F',
            'Finger_Heart': 'Gracias',
            'Hand_Wave': 'Adiós'
        };
        return gesturesMap[gesture] || '';
    }

    updateSentence(text) {
        this.sentence.push(text);
        
        if (this.sentence.length > 15) {
            this.sentence = this.sentence.slice(-10);
        }
        
        this.output.textContent = this.sentence.join('')
            .replace(/\s+/g, ' ')
            .trim();
    }
}

// Iniciar aplicación
new SignLanguageTranslator();
</script>
</body>
</html>
